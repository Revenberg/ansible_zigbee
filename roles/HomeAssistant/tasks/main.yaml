---
- name: Update apt-get cache
  apt: >
    update_cache=yes
    cache_valid_time=360

- name: Install Home Assistant applications
  apt: 
    name: [ "python3", "python3-dev", "python3-venv", "python3-pip", "libffi-dev", "libssl-dev", "libjpeg-dev", "zlib1g-dev", "autoconf", "build-essential", "libopenjp2-7", "libtiff5" ]

- name: Ensure group "homeassistant" exists
  group:
    name: homeassistant
    state: present

- name: sudo without password for homeassistant group
  copy:
    content: '%homeassistant ALL=(ALL:ALL) NOPASSWD:ALL'
    dest: /etc/sudoers.d/homeassistant_nopasswd
    mode: 0440

- name: Add the user 'homeassistant' with primary group of 'dialout'
  user:
    name: homeassistant
    comment: homeassistant user
    group: homeassistant
    groups: root, dialout

- name: create /srv/homeassistant
  file:
    path: /srv/homeassistant
    recurse: yes
    mode: 0760
    owner: homeassistant
    group: homeassistant

- name: create to a virtual environment for Home Assistant Core
  shell:
    cmd: "python3.8 -m venv ."
  become_user: homeassistant
  args:
    chdir: /srv/homeassistant

- name: change to a virtual environment for Home Assistant Core
  shell:
    cmd: "source bin/activate"
  become_user: homeassistant
  args:
    chdir: /srv/homeassistant

- name: Install required Python package
  shell:
    cmd: "python3 -m pip install wheel"
  become_user: homeassistant
  args:
    chdir: /srv/homeassistant    

- name: Install homeassistant
  shell:
    cmd: "pip3 install homeassistant"
  become_user: homeassistant
  args:
    chdir: /srv/homeassistant     

- name: Start Home Assistant Core for the first time.
  shell:
    cmd: "hass"
  become_user: homeassistant
  args:
    chdir: /srv/homeassistant     
