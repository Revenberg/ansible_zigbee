---
- name: current date time
  debug: 
    msg: "{{lookup('pipe','date \"+%Y-%m-%d %H:%M\"')}}"

- name: "download node-red"
  shell:
    cmd: "curl -sL https://deb.nodesource.com/setup_8.x | sudo -E bash -"

- name: Install nodered
  apt:
    name: [ "nodered ", "nodejs", "npm", "node-semver"]
    state: present
    update_cache: yes

- name: npm install npm@latest
  shell: "curl https://www.npmjs.com/install.sh | sudo sh"
  args:
    chdir: /home/pi

- set_fact:
    pi_password: "{{lookup('file', '{{ pswrdfile }}') }}"

- name: set credentialSecret
  lineinfile:
    path: /usr/lib/node_modules/node-red/settings.js
    line: 'credentialSecret: "{{ pi_password }}", '
    insertafter: '//credentialSecret: "a-secret-key",'
    create: no

- name: set credentialSecret pi
  lineinfile:
    path: /home/pi/.node-red/settings.js
    line: 'credentialSecret: "{{ pi_password }}", '
    insertafter: '//credentialSecret: "a-secret-key",'
    create: no
  ignore_errors: yes

- name: "systemctl enable nodered.service"
  systemd:
    state: started
    enabled: yes
    name: nodered
